# 验证与权限

这里我们先以项目为例，了解一些验证与权限相关的信息。

## 登录验证

后台项目区别于其他项目的一大特点，就是权限验证及其安全性。我们开发时一般做的第一个页面，就是登录页面，它们是息息相关的。

用户输入用户名和密码后，首先通过前端的输入格式和验证工具进行验证，验证成功后，再`login`到服务端验证此用户是否存在及密码是否正确。验证成功后，服务端会返回一个`token`和用户信息，它们会被存到`sessionStorage`中，作为与后端数据交互的权限标识。

### 前端验证

一般验证方式：

- 输入格式验证
- 验证工具：短信验证码、字符验证码、滑块图、文案编辑等

### 后端验证

- 一般通过数据库校验进行登录验证
- 通过用户角色信息进行权限控制

## 权限使用

通过上面的讲述，我们可以知道这里的权限控制有两种，登录权限（是否能成功登录）和角色权限（角色信息如菜单路由、操作按钮权限）。来看看具体是如何实现的吧！

上面我们已经详细讲过权限中有关角色路由表的内容，这里我们再看看更细粒化的按钮权限。

通常我们会以角色来做权限判定标准，执行可许的权限操作。

### 权限路由控制

首先我们来分析，通过权限，有哪些方式可以控制路由。

#### 思路一

纯后端动态控制路由表，前端写好页面及其路由

```typescript
const routes = [
  {
    path: "/test",
    component: () => import("/@/views/test/test.vue"),
  },
];
```

登录后，根据用户的权限，路由表（含所有路由配置项）全部从后端一次性获取

```js
{
    path: "/test",
    name: "test",
    redirect: "/test/test",
    meta: {
        title: "test",
        icon: "test_icon",
        i18n: true,
        showLink: true,
        rank: 100
	},
	children: {...}
}
```

#### 思路二

前端控制页面级权限：拿到后端用户返回的角色`role`，映射出前端写好的路由表控制当前角色能够看到的页面（如菜单栏）

前端写好页面及所有路由表

```typescript
const routes =[
	{
	path: '/test',
    name: "test",
    component: () => import('/@/views/test/test.vue')
    meta: {
        title: "test",
        icon: "test_icon",
        roles: ['admin', 'test'] // 用户角色符合该配置项，则将该路由添加进最终路由表
	},
	children: {...}
	}
]
```

后端控制请求权限：用户向服务端发送请求头携带`token`的请求，服务端根据用户角色来验证是否有该操作的权限

#### 思路三

通过`info`获取到`role`，再从后端动态地根据`role`拿到权限相关的信息（如动态路由表、按钮权限），将通过权限过滤出来的动态路由表，与前端写好的静态路由表结合，生成最终路由表。

本项目采用思路三的方式开发的原因：

- 静态路由与动态路由区分开
- 通过用户角色过滤动态路由表，菜单栏由路由表动态生成
- 权限相对灵活，后端对角色权限的改动，前端不需要跟着改动

### 简单实现

登录的成功后，我们做了一个初始化路由操作，传入用户角色的参数，目的就是拿到一份对应角色的动态路由表，也就是权限的过滤。

```typescript
// src/views/login.vue
const onLogin = (): void => {
  storageSession.setItem("info", {
    username: "admin",
    accessToken: "eyJhbGciOiJIUzUxMiJ9.test",
  });
  initRouter("admin").then(() => {}); // 初始化路由
  router.push("/");
};
```

这份后端传过来的动态路由表（`permissionRouter`），我们在`mock`（mock/asyncRoutes.ts）中模拟出来，后端同样是根据用户角色参数来返回正确的动态路由信息。

```typescript
export default [
  {
    url: "/getAsyncRoutes",
    method: "get",
    response: ({ query }) => {
      if (query.name === "admin") {
        // 不同角色返回不同的路由信息
        return {
          code: 0,
          info: [setDifAuthority("v-admin", permissionRouter)],
        };
      } else {
        return {
          code: 0,
          info: [setDifAuthority("v-test", permissionRouter)],
        };
      }
    },
  },
] as MockMethod[];
```

### 直接使用用户信息

这里我们以权限界面的一个简单角色切换功能为例分析（src/views/permisson/page/index）：

```typescript
import { storageSession } from "/@/utils/storage"; // 拿到用户的 info

let purview = ref<string>(storageSession.getItem("info").username); // 获取用户角色（username）

function changRole() {
  if (unref(purview) === "admin") {
    // 是 admin，则有权限作如下操作
    storageSession.setItem("info", {
      username: "test",
      accessToken: "eyJhbGciOiJIUzUxMiJ9.test",
    });
    window.location.reload();
  } else {
    storageSession.setItem("info", {
      username: "admin",
      accessToken: "eyJhbGciOiJIUzUxMiJ9.admin",
    });
    window.location.reload();
  }
}
```

### 使用角色指令

`auth`指令

```typescript
// src/directives/permission/index.ts
export const auth: Directive = {
  mounted(el: HTMLElement, binding: DirectiveBinding) {
    const { value } = binding;
    if (value) {
      const authRoles = value;
      const hasAuth = usePermissionStoreHook().buttonAuth.includes(authRoles);
      if (!hasAuth) {
        el.parentNode.removeChild(el);
      }
    } else {
      throw new Error("need roles! Like v-auth=\"['admin','test']\"");
    }
  },
};
```

指令可以帮助我们像使用 v-model 一样，快速的达到想要的效果，比如做角色判定（src/views/permisson/button.index.vue）。

```html
<script setup lang="ts">
  const auth = ref<boolean>(storageSession.getItem("info").username || "admin"); // 拿到用户角色
  ......
</script>

<template>
  <div>
    <el-radio-group v-model="auth" @change="changRole">
      <el-radio-button label="admin"></el-radio-button>
      <el-radio-button label="test"></el-radio-button>
    </el-radio-group>
    <!-- 绑定 auth 指令，不同指令参数显示不同标签 -->
    <p v-auth="'v-admin'">只有admin可看</p>
    <p v-auth="'v-test'">只有test可看</p>
  </div>
</template>
```
